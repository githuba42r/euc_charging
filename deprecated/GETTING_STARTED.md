# Leaperkim Sherman S Bluetooth LE Client - Complete Setup Guide

## Quick Start

### 1. Install Dependencies
```bash
cd /home/philg/working/euc-dump
npm install
```

### 2. Run Setup Script
```bash
./setup.sh
```

### 3. Discover Device Services
```bash
sudo node discover.js
```
This will find your device and enumerate all available services/characteristics.

### 4. Connect and Capture Data
```bash
sudo node client.js
```
Let this run while your device is charging. It will log all data to `battery_data.log`.

### 5. Analyze the Data
```bash
node test-decoder.js
```
This will show you possible interpretations of the captured data.

---

## File Structure

```
euc-dump/
├── package.json              # Node.js project config
├── README.md                 # Project overview
├── setup.sh                  # Setup and dependency script
│
├── discover.js               # Scan for device and discover services
├── client.js                 # Main BLE client (connect and read data)
├── decoder.js                # Decode battery data from raw bytes
├── test-decoder.js           # Test harness for the decoder
├── config.js                 # Configuration template
│
├── REVERSE_ENGINEERING.md    # Detailed reverse engineering guide
├── ESPHOME_GUIDE.md          # ESPHome integration guide
│
└── battery_data.log          # Generated by client.js (captured data)
```

---

## Step-by-Step Process

### Phase 1: Device Discovery (TODAY)

**Goal:** Identify services and characteristics exposed by your device

**Steps:**
1. Ensure your Leaperkim device is powered on and in range
2. Run: `sudo node discover.js`
3. The script will:
   - Scan for 30 seconds
   - Find your device (MAC: 88:25:83:F3:5D:30)
   - Connect to it
   - List all services and characteristics
   - Disconnect

**What you're looking for:**
- Service UUIDs (especially custom ones)
- Characteristic UUIDs for battery data
- Which characteristics support 'notify' or 'indicate'
- Data that appears to be battery-related

**Output Example:**
```
Service: 180f
  Characteristic: 2a19 (Battery Level)
    Properties: read, notify

Service: custom-uuid-here
  Characteristic: f001
    Properties: notify
```

**Record the output in `REVERSE_ENGINEERING.md`**

---

### Phase 2: Data Capture (NEXT)

**Goal:** Capture real battery data while device is charging

**Steps:**
1. Connect your Leaperkim to a charger
2. Run: `sudo node client.js`
3. Let it run for at least 5-10 minutes while charging
4. Stop it: `Ctrl+C`

**What happens:**
- Attempts to subscribe to battery notifications
- If no notifications, tries to read characteristics periodically
- Logs all data to `battery_data.log`
- Attempts to decode data in real-time

**Check the logs:**
```bash
cat battery_data.log
# Or watch in real-time:
tail -f battery_data.log
```

---

### Phase 3: Data Analysis (NEXT)

**Goal:** Understand the data format and decode battery metrics

**Steps:**
1. Run: `node test-decoder.js`
2. Review the analysis output
3. Look for patterns that match expected values:
   - Battery level: 0-100%
   - Voltage: ~48-60V (depends on your model)
   - Current: 0-5A when charging

**The decoder will suggest interpretations:**
- Check "High Confidence" interpretations first
- Verify values match device's built-in display
- Note any patterns in the data structure

**Example output:**
```
Battery: 85%, Voltage: 48.54V, Current: 2.44A
```

---

### Phase 4: Protocol Documentation (NEXT)

**Goal:** Document the exact data format for implementation

**Steps:**
1. Based on Phase 3 analysis, update `config.js`
2. Fill in:
   - Service UUID
   - Characteristic UUID
   - Data format (byte structure)
   - Scaling factors (if needed)

**Example:**
```javascript
{
  batteryLevel: uint8 at offset 0 (%)
  voltage: uint16le at offset 1 (mV, scale by 0.001 to get V)
  current: int16le at offset 3 (mA, scale by 0.001 to get A)
}
```

---

### Phase 5: Node.js Implementation (NEXT)

**Goal:** Create a robust Node.js BLE client

**Current Status:** ✓ Complete (decoder and client already created)

**The client already:**
- Discovers your device automatically
- Subscribes to battery notifications
- Falls back to periodic reads if needed
- Parses and displays battery data
- Logs everything for analysis

**You just need to verify it works with your device**

---

### Phase 6: ESPHome Integration (FUTURE)

**Goal:** Create Home Assistant integration

**Steps:**
1. Set up an ESP32 with ESPHome
2. Configure Bluetooth Proxy
3. Create custom BLE client component (template provided)
4. Deploy to Home Assistant
5. Create sensors and automations

**See:** `ESPHOME_GUIDE.md`

---

## Troubleshooting

### "Device not found"
- Check device is powered on
- Check Bluetooth is enabled: `bluetoothctl show`
- Try manual scan: `bluetoothctl scan on`
- Verify MAC address (88:25:83:F3:5D:30)

### "Permission denied" errors
Option 1 - Add user to bluetooth group:
```bash
sudo usermod -a -G bluetooth $USER
# Logout and login
```

Option 2 - Use sudo:
```bash
sudo node discover.js
```

### "No data received"
- Device may not be advertising notifications
- May need to send a write command first to enable it
- Try using `bluetoothctl` to manually enable notifications:
  ```bash
  bluetoothctl
  connect 88:25:83:F3:5D:30
  gatt.list-attributes
  # Find battery characteristic and check properties
  ```

### Data doesn't match expected values
- Check byte order (little-endian vs big-endian)
- Verify scaling factors
- Compare against device's built-in display
- May need to capture more samples

---

## Useful Tools

### Bluetooth Scanner (Android)
Use "nRF Connect" or "BLE Scanner" app to view:
- Available services
- Characteristics and their data
- Real-time updates
- Great for manual verification

### bluetoothctl (Linux)
```bash
# List paired devices
bluetoothctl devices

# Connect to device
bluetoothctl connect 88:25:83:F3:5D:30

# Enable notifications on a characteristic
# (Find UUID from discovery.js output)
bluetoothctl gatt.list-attributes
bluetoothctl select-attribute /org/bluez/.../char0001
bluetoothctl notify on
```

### hcidump (Linux)
```bash
# Capture raw BLE packets
sudo hcidump -i hci0 -X > ble_capture.log

# Then analyze in Wireshark (Linux GUI)
```

### Wireshark (Linux)
```bash
# GUI-based packet capture and analysis
sudo wireshark
# Select Bluetooth interface
# Filter for: btle
# Look for ATT packets with Handle values
```

---

## Expected Data Patterns

Based on typical electric unicycle battery systems:

### Battery Level
- Single byte: 0-100 (%)
- Often sent as notifications

### Voltage
- Typical range: 48-67V for this model
- Encoding: Usually millivolts (mV) as uint16
  - 48000 mV = 48V
  - Stored as 0xE0, 0xBB (little-endian)

### Current
- Charging current: 0-10A typical
- Encoding: Usually milliamps (mA) as int16
  - 2500 mA = 2.5A
  - Stored as 0xC4, 0x09 (little-endian signed)

### Combined Format
Many devices combine all three in a single characteristic:
```
Byte 0:     Battery Level (0-100%)
Bytes 1-2:  Voltage (uint16 LE, in mV)
Bytes 3-4:  Current (int16 LE, in mA)
```

---

## Next Steps After Discovery

1. **Immediate:** Run discover.js and capture services
2. **Then:** Run client.js while charging and capture data logs
3. **Then:** Analyze logs with test-decoder.js
4. **Document:** Update config.js with discovered format
5. **Implement:** Verify client works correctly with your device
6. **Extend:** Add ESPHome integration
7. **Integrate:** Set up Home Assistant automations

---

## Community Resources

### Similar Projects
- **King Song Wheel BLE Protocol** - Well documented
- **Inmotion (IPS) Wheel** - Custom BLE services
- **Gotway Wheel** - Similar voltage/current telemetry

### Bluetooth LE Resources
- [Bluetooth GATT Services](https://www.bluetooth.com/specifications/gatt/services/)
- [Characteristic UUIDs](https://www.bluetooth.com/specifications/gatt/characteristics/)
- [GATT Specification](https://www.bluetooth.com/specifications/bluetooth-core-specification)

### ESPHome
- [ESPHome Documentation](https://esphome.io/)
- [BLE Client Component](https://esphome.io/components/ble_client.html)
- [Home Assistant Integration](https://www.home-assistant.io/)

---

## Questions & Notes

Use this space to track discoveries:

### Device Characteristics
- Model: Leaperkim Sherman S
- MAC: 88:25:83:F3:5D:30
- Services Found:
- Main Battery Characteristic:
- Data Update Frequency:

### Data Format
- Total Length: ___ bytes
- Battery Offset: ___ Field Type: ___
- Voltage Offset: ___ Field Type: ___
- Current Offset: ___ Field Type: ___

### Important Notes
- [ ] Device requires pairing first?
- [ ] Notifications enabled automatically?
- [ ] Need write command to enable data?
- [ ] Data only available during charging?

---

## File Cleanup

After you're done, you can remove:
- `battery_data.log` (captured data)
- Node modules if not needed: `rm -rf node_modules`

Keep everything else for reference and future ESPHome integration.

---

Good luck with your reverse engineering! Feel free to update this guide with your discoveries.
